# 🔧 Cloudflare 构建优化方案

## ⚠️ Exit code 9 错误原因

错误代码 9 通常表示：
- 内存不足（OOM - Out of Memory）
- 构建进程被终止
- Node.js 堆内存溢出

---

## 🎯 解决方案

### 方案 1：限制内存使用（推荐）

修改 Cloudflare 构建命令为：

```bash
yarn install && NODE_OPTIONS="--max-old-space-size=2048" yarn build
```

这会限制 Node.js 最多使用 2GB 内存。

---

### 方案 2：分阶段构建

```bash
yarn install --frozen-lockfile && yarn build
```

使用 `--frozen-lockfile` 避免 Yarn 重新计算依赖。

---

### 方案 3：禁用并行构建

在每个项目的 `vue.config.js` 中添加：

```javascript
module.exports = {
  parallel: false, // 禁用并行构建
  // ... 其他配置
}
```

然后构建命令：
```bash
yarn install && yarn build
```

---

## 📝 完整 Cloudflare 配置

### 环境变量

```
NODE_VERSION = 14.16.0
NODE_OPTIONS = --max-old-space-size=2048
```

### 构建命令

```
yarn install && yarn build
```

---

## 🔍 调试步骤

如果还是失败，查看构建日志中：

1. **内存使用情况**
   - 搜索 "heap out of memory"
   - 搜索 "JavaScript heap"

2. **哪个阶段失败**
   - yarn install 阶段？
   - yarn build 阶段？
   - 编译哪个文件时失败？

---

## 💡 临时解决方案

如果 Cloudflare Pages 构建一直失败，可以：

### 本地构建 + 直接部署

1. **本地构建**
   ```bash
   cd /Users/adam/maollar-project/frontend/manager
   yarn install
   yarn build
   ```

2. **使用 Wrangler 直接部署**
   ```bash
   npx wrangler pages deploy dist --project-name=maollar-manager
   ```

这样可以绕过 Cloudflare 的构建环境限制。

---

## 📊 各方案对比

| 方案 | 优点 | 缺点 |
|------|------|------|
| 限制内存 | 简单，通常有效 | 可能构建变慢 |
| 禁用并行 | 内存占用最低 | 构建时间更长 |
| 本地构建 | 100% 可控 | 需要手动构建 |

---

**建议先试方案 1（限制内存），如果不行就用本地构建！**
